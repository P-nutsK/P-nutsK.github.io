const socket=new WebSocket("wss://clouddata.scratch.mit.edu/");console.enablelog=!0,socket.onmessage=function(e){console.enablelog&&console.log(cloudgetJSON(e)),window.thatWindow.postMessage(cloudgetJSON(e))},console.log(socket);const username=document.querySelector("#navigation > div > ul > li.link.right.account-nav > div > a > span").textContent,projectId=location.pathname.replace(/[^0-9]/g,"");function createElements(){let e=createElement("h1");e.append("☁ CloudManager");let t=createElement("span","projectTitle");fetch(`https://api.scratch.mit.edu/projects/${projectId}`).then(e=>e.json()).then(e=>e.title).then(e=>t.append(e));let n=createElement("br"),a=createElement("button","handshake");a.append("handshake");let l=createElement("button","switchlog");l.append("ログ出力");let o=createElement("br"),r=createElement("select","terget"),d=createElement("input",{id:"valueinput",type:"number",placeholder:"\xb1256桁までの数"}),s=createElement("button",{id:"send",disabled:"disabled"});s.append("send");let c=createElement("table"),p=createElement("thead"),i=createElement("tr"),u=createElement("th",{colSpan:"1"});u.append("変数名");let h=createElement("th",{colSpan:"1"});h.append("値"),i.append(u,h),p.append(i);let m=createElement("tbody","cloudtable");c.append(p,m);let g=createElement("script",{src:"https://p-nutsk.github.io/projects/cloudmanager/popup.js"});return[e,t,n,a,l,o,r,d,s,c,g]}function cloudgetJSON(e){let t=e.data.split("\n").slice(0,-1);return t.forEach((e,n)=>{t[n]=JSON.parse(e)}),t}function createElement(e,t){console.log("name:",e,"data",t);let n=document.createElement(e);return void 0!=t&&("string"==typeof t?n.id=t:Object.keys(t).forEach(e=>{n[e]=t[e]})),console.log(n),n}window.thatWindow=window.open("","_blank","menubar=0,width=675,height=300,top=100,left=100"),window.thatWindow.document.head.append(createElement("link",{href:"https://p-nutsk.github.io/projects/cloudmanager/popup.css",rel:"stylesheet"})),window.thatWindow.document.body.append(...createElements()),window.addEventListener("message",e=>{let t=e.data;console.log(e),"handshake"===t.type&&(socket.send(`${JSON.stringify({method:"handshake",project_id:projectId,user:username})}
`),console.log("handshake"),window.thatWindow.document.querySelector("#send").removeAttribute("disabled")),"send"===t.type&&(socket.send(`${JSON.stringify({method:"set",project_id:projectId,user:username,name:t.terget,value:t.value})}
`),window.thatWindow.postMessage([{method:"set",project_id:projectId,user:username,name:t.terget,value:t.value}]),console.log("ws Send")),"system_switchlog"===t.type&&(console.enablelog?(console.enablelog=!1,console.log("サーバーからのメッセージを表示しないようにしました")):(console.enablelog=!0,console.log("メッセージ表示を再開しました")))});
